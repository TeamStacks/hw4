<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="description" content="bullion management site, rare coins, gold, silver, platinum">
    <meta name="author" content="CSE134B Dream Team">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="./style/style.css">
    <meta name=viewport content="width=device-width, initial-scale=.8, minimum-scale = .8, user-scalable=yes">
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <script src="./js/jquery-1.11.2.min.js"></script>
    <script src="./js/velocity.min.js"></script>
    <script src="./js/main.js"></script>
    <script src="./js/account.js"></script>
    <script type="text/javascript" src="./js/parse-1.4.2.min.js"></script>
    <script type="text/javascript" src="./js/parsefb.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <title>New Item - CoinFlip</title>
</head>

<body>
    <script type="text/javascript">
    loadTopNav();
    </script>
    <script type="text/javascript">
    loadSideNav(1);
    </script>
    <section class="main-section">
        <section class="coin_wrapper">
            <div class="mobile-nav">
                <a href="wire3.html">
                    <svg class="icon icon-keyboard-arrow-left">
                        <symbol id="icon-keyboard-arrow-left" viewBox="0 0 1024 1024">
                            <title>keyboard-arrow-left</title>
                            <path class="path1" d="M657.707 696.96l-195.627-195.627 195.627-195.627-60.373-60.373-256 256 256 256z"></path>
                        </symbol>
                        <use xlink:href="#icon-keyboard-arrow-left"></use>
                    </svg>
                </a>
                ADD ITEM
            </div>
            <div class="coin_main">
                <a href="wire3.html">
                    <div class="breadcrumb">
                        <svg class="icon icon-play-arrow-rev">
                            <symbol id="icon-play-arrow" viewBox="0 0 1024 1024">
                                <title>play-arrow</title>
                                <path class="path1" d="M682.667 213.333v597.333l-469.333-298.667z"></path>
                            </symbol>
                            <use xlink:href="#icon-play-arrow"></use>
                        </svg>
                        Add Item
                    </div>
                </a>
                <section class="coin_image" >
                    
                    <div class="img_box">
                        <a href="#uploadimg" data-toggle="modal" data-target="#uploadimg">
                            <div class="img_container">
                                <div class="img_circle">
                                </div>
                            </div>
                        </a>
                    </div> 
                    <!-- 
                    <input type="file" id="uploadimg"></input> -->
                </section>
                <section class="coin_detail">
                    <table>
                        <tr>
                            <td>Metal</td>
                            <td>
                                <select id="metal">
                                    <option value="Gold">Gold</option>
                                    <option value="Silver">Silver</option>
                                    <option value="Platinum">Platinum</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Type</td>
                            <td>
                                <select id="type">
                                    <option selected value="US Eagle">US Eagle</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Purchase Date</td>
                            <td>
                                <input id="purchase_date" name="purchase_date" type="date" />
                            </td>
                        </tr>
                        <tr>
                            <td>Qty.</td>
                            <td>
                                <input id="quantity" name="quantity" class="values"/>
                            </td>
                        </tr>
                        <tr>
                            <td>Premium</td>
                            <td>
                                <input id="premium" name="quantity"/>
                            </td>
                        </tr>
                        <tr>
                            <td>Unit Price</td>
                            <td>
                                <input id="unit_price" name="quantity" class="values"/>
                            </td>
                        </tr>
                        <tr>
                            <td>Gold %</td>
                            <td id="metal_percentage">0.999</td>
                        </tr>
                        <tr>
                            <td>Weight/unit (g)</td>
                            <td id="weight_per_unit" class="values">1.244</td>
                        </tr>
                        <tr>
                            <td>Gold g/u</td>
                            <td id="grams_per_unit">1.244</td>
                        </tr>
                        <tr>
                            <td>Gold ozt/u</td>
                            <td id="ozt_per_unit">0.0400</td>
                        </tr>
                        <tr>
                            <td>Total au (ozt)</td>
                            <td>0.0400</td>
                        </tr>
                        <tr>
                            <td><strong>TOTAL</strong></td>
                            <td><strong id="total_value">0.0</strong></td>
                        </tr>
                    </table>
                    <a href="#"><span id="save">Save to My Stack</span></a>
                    <a href="wire3.html"><span id="cancel">Cancel</span></a>
                </section>
            </div>
        </section>
    </section>

<div class="modal fade" id="profile" tabindex="-1" role="dialog" aria-labelledby="ProfileModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close2 btn btn-default" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="ProfileModal">MY PROFILE</h4>
        </div>
        <form>
          <div class="modal-body">
            <div class="form-group">
              <label>USERNAME</label>
              <br>
              <p id="user" class="no-dec"></p>
            </div>
            <div class="form-group">
              <label for="pass">NEW PASSWORD</label>
              <input type="password" class="form-control" id="pass" placeholder="Password">
            </div>
            <button type="button" class="btn btn-primary" onclick="update()">Update Profile</button>
            <button type="button" id ="fblink" class="btn btn-primary" onclick="linkfb()">Link Facebook</button>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" onclick="logOut()">Log Out</button>
          </div>
        </form>
      </div>
    </div>
  </div>

    <div class="modal fade" id="uploadimg" tabindex="-1" role="dialog" aria-labelledby="UploadModal" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close2 btn btn-default" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="UploadModal">UPLOAD A PICTURE</h4>
          </div>
            <div class="modal-body">
                <p>We only support JPG/JPEG images at the moment.</p>
                <input type="file" id="coinfile"></input>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="upImg()">Upload</button>
            </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
    verify();
    loadFooter();

    // calculations for the ajax total
    $(".values").keyup(function() {
        var total = 1;
        $(".values").each(function(){
            total *= Number($(this).val());
        });
        $("#total_value").text(total);
        console.log("current total: " + total);
    });

    // for checking if valid input before submitting
    function validateAdd() {
        // not sure, but parse might validate for us already - Angie
    }

    function upImg() {
        var uploadImage = $("#coinfile")[0];
             var file = uploadImage.files[0];
             var name = $('#coinfile').val().replace(/C:\\fakepath\\/i, '');
         // This function is called when the user clicks on Upload to Parse. It will create the REST API request to upload this image to Parse.
      var serverUrl = 'https://api.parse.com/1/files/' + name;

      $.ajax({
        type: "POST",
        beforeSend: function(request) {
          request.setRequestHeader("X-Parse-Application-Id", 'm8lsJLtBtcOGqT0h9RmcWRIpxpiwyb3Yq6HqrCk2');
          request.setRequestHeader("X-Parse-REST-API-Key", 'JrtCwMABQRvOOtixhzLAZwk46nhxnUlJBIuxx1NZ');
          request.setRequestHeader("Content-Type", file.type);
        },
        url: serverUrl,
        data: file,
        processData: false,
        contentType: false,
        success: function(data) {
          alert("File available at: " + data.url);
        },
        error: function(data) {
          var obj = jQuery.parseJSON(data);
          alert(obj.error);
        }
      });

        // var uploadImage = $("#coinfile")[0];

        //  if(uploadImage.files.length > 0) {
        //     console.log("Uploading an image called " + filename);
        //     var file = uploadImage.files[0];
        //     var name = $('#coinfile').val().replace(/C:\\fakepath\\/i, '');
        //     var imageFile = new Parse.File(name, file);

        //     var result = imageFile.save()
        // }
        ////////////
        //var newImg = new Parse.File(filename, newImg);


        // var xhr = new XMLHttpRequest();
        // xhr.open("POST", "https://api.parse.com/1/files/" + filename, true);
        // xhr.setRequestHeader("X-Parse-Application-Id", "m8lsJLtBtcOGqT0h9RmcWRIpxpiwyb3Yq6HqrCk2");
        // xhr.setRequestHeader("X-Parse-REST-API-Key", "JrtCwMABQRvOOtixhzLAZwk46nhxnUlJBIuxx1NZ");
        // xhr.setRequestHeader("Content-Type", "image/jpeg");


        // xhr.send(newImg);
        // xhr.onreadystatechange = function() {
        //   if (xhr.readyState == 4) {
        //     var result = JSON.parse(xhr.responseText);
        //     if (result.url) {
        //       console.log("saved an object with id: " + result.url);
              
        //     }
        //   }
        // }

    }

    // saving the coin and inventory
    function saveCoin() {
        var type = $("#type").val();
        var gramsPerUnit = parseFloat($("#grams_per_unit").text());
        var metal = $("#metal").val();
        var metalPercentage = parseFloat($("#metal_percentage").text());
        var oztPerUnit = parseFloat($("#ozt_per_unit").text());
        var premium = parseFloat($("#premium").val());
        var unitPrice = parseFloat($("#unit_price").val());
        var weightPerUnit = parseFloat($("#weight_per_unit").text());

        var Coin = Parse.Object.extend("Coin");
        var coin = new Coin();

        coin.save({
            Type: type,
            gramsPerUnit: gramsPerUnit,
            metal: metal,
            metalPercentage: metalPercentage,
            oztPerUnit: oztPerUnit,
            premium: premium,
            unitPrice: unitPrice,
            weightPerUnit: weightPerUnit
        }, {
            success: function(coin) {
                saveInventory(coin);
            },
            error: function(coin, error) {
                alert("Unable to save coin!");
            }
        });
    }

    function saveInventory(coin) {
        var Inventory = Parse.Object.extend("Inventory");
        var inventory = new Inventory();

        var uploadImage = $("#upload-img")[0];
        var purchaseDate = new Date($("#purchase_date").val());
        var quantity = parseInt($("#quantity").val());
        var type = coin;
        var totalValue = parseFloat($("#total_value").text());

        if(uploadImage.files.length > 0) {
            var file = uploadImage.files[0];
            var name = "coin.jpg";
            var imageFile = new Parse.File(name, file);

            imageFile.save().then(function() {
                inventory.save({
                    purchaseDate: purchaseDate,
                    quantity: quantity,
                    type: type,
                    ownedBy: Parse.User.current(),
                    image: imageFile,
                    value: totalValue
                }, {
                    success: function(inventory) {
                        window.location.href = "./wire3.html";
                    },
                    error: function(inventory, error) {
                        alert("Unable to save inventory!");
                    }
                });
            }, function(error) {
                alert("Unable to save inventory!");
            });
        } else {
            inventory.save({
                purchaseDate: purchaseDate,
                quantity: quantity,
                type: type,
                ownedBy: Parse.User.current(),
                value: totalValue
            }, {
                success: function (inventory) {
                    window.location.href = "./wire3.html";
                },
                error: function (inventory, error) {
                    alert("Unable to save inventory!");
                }
            });
        }
    }

    $("#save").click(function() {
        saveCoin();
    });

    $("#cancel").click(function() {
        window.location.href = "/wire3.html";
    });
    </script>
</body>

</html>
