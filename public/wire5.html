<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="description" content="bullion management site, rare coins, gold, silver, platinum">
    <meta name="author" content="CSE134B Dream Team">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="./style/style.css">
    <meta name=viewport content="width=device-width, initial-scale=.8, minimum-scale = .8, user-scalable=yes">
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <script src="./js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="./js/parse-1.4.2.min.js"></script>
    <script type="text/javascript" src="./js/parsefb.js"></script>
    <script src="./js/account.js"></script>
    <script src="./js/velocity.min.js"></script>
    <script src="./js/main.js"></script>
    <script src="./js/query.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <title>New Item - CoinFlip</title>
</head>

<body>
    <script type="text/javascript">
    loadTopNav();
    </script>
    <script type="text/javascript">
    loadSideNav(-1);
    </script>
    <section class="main-section">
        <section class="coin_wrapper">
            <div class="mobile-nav">
                <a href="#" onclick="window.history.back(-1);">
                    <svg class="icon icon-keyboard-arrow-left">
                        <symbol id="icon-keyboard-arrow-left" viewBox="0 0 1024 1024">
                            <title>keyboard-arrow-left</title>
                            <path class="path1" d="M657.707 696.96l-195.627-195.627 195.627-195.627-60.373-60.373-256 256 256 256z"></path>
                        </symbol>
                        <use xlink:href="#icon-keyboard-arrow-left"></use>
                    </svg>
                </a>
                ADD ITEM
            </div>
            <div class="coin_main">
                <a href="#" onclick="window.history.back(-1);">
                    <div class="breadcrumb">
                        <svg class="icon icon-play-arrow-rev">
                            <symbol id="icon-play-arrow" viewBox="0 0 1024 1024">
                                <title>play-arrow</title>
                                <path class="path1" d="M682.667 213.333v597.333l-469.333-298.667z"></path>
                            </symbol>
                            <use xlink:href="#icon-play-arrow"></use>
                        </svg>
                        Add Item
                    </div>
                </a>
                <section class="coin_image" >
                    
                    <div class="img_box">
                        <a href="#uploadimg" data-toggle="modal" data-target="#uploadimg">
                            <div class="img_container">
                                <div class="img_circle">
                                </div>
                            </div>
                        </a>
                    </div> 
                    <!-- 
                    <input type="file" id="uploadimg"></input> -->
                    <p>Click above to upload a new image.</p>
                </section>
                <section class="coin_detail">
                    <table>
                        <tr>
                            <td>Metal</td>
                            <td>
                                <select id="metal" onchange="onMetalChange()">
                                    <option value="Gold">Gold</option>
                                    <option value="Silver">Silver</option>
                                    <option value="Platinum">Platinum</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Type</td>
                            <td>
                                <select id="type">
                                    <option selected value="US Eagle">US Eagle</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>Purchase Date</td>
                            <td>
                                <input id="purchase_date" name="purchase_date" type="date" />
                            </td>
                        </tr>
                        <tr>
                            <td>Qty.</td>
                            <td>
                                <input id="quantity" name="quantity" class="values"/>
                            </td>
                        </tr>
                        <tr>
                            <td>Premium</td>
                            <td>
                                <input id="premium" name="quantity" class="values"/>
                            </td>
                        </tr>
                        <tr>
                            <td>Unit Price</td>
                            <td>
                                <input id="unit_price" name="quantity" class="values"/>
                            </td>
                        </tr>
                        <tr>
                            <td id="metal_percentage_label">Gold %</td>
                            <td id="metal_percentage">0.9167</td>
                        </tr>
                        <tr>
                            <td>Weight/unit (g)</td>
                            <td id="weight_per_unit">33.930</td>
                        </tr>
                        <tr>
                            <td id="grams_per_unit_label">Gold g/u</td>
                            <td id="grams_per_unit">33.930</td>
                        </tr>
                        <tr>
                            <td id="ozt_per_unit_label">Gold ozt/u</td>
                            <td id="ozt_per_unit">1.0909</td>
                        </tr>
                        <tr>
                            <td id="total_metal_ozt_label">Total au (ozt)</td>
                            <td id="total_metal_ozt">0</td>
                        </tr>
                        <tr>
                            <td><strong>TOTAL</strong></td>
                            <td><strong id="total_value">0</strong></td>
                        </tr>
                    </table>
                    <a href="#"><span id="save">Save to My Stack</span></a>
                    <a href="#" onclick="window.history.back(-1);"><span id="cancel">Cancel</span></a>
                </section>
            </div>
        </section>
    </section>

<div class="modal fade" id="profile" tabindex="-1" role="dialog" aria-labelledby="ProfileModal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close2 btn btn-default" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="ProfileModal">MY PROFILE</h4>
        </div>
        <form>
          <div class="modal-body">
            <div class="form-group">
              <label>USERNAME</label>
              <br>
              <p id="user" class="no-dec"></p>
            </div>
            <div class="form-group">
              <label for="pass">NEW PASSWORD</label>
              <input type="password" class="form-control" id="pass" placeholder="Password">
            </div>
            <button type="button" class="btn btn-primary" onclick="update()">Update Profile</button>
            <button type="button" id ="fblink" class="btn btn-primary" onclick="linkfb()">Link Facebook</button>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" onclick="logOut()">Log Out</button>
          </div>
        </form>
      </div>
    </div>
  </div>

    <div class="modal fade" id="uploadimg" tabindex="-1" role="dialog" aria-labelledby="UploadModal" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close2 btn btn-default" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="UploadModal">UPLOAD A PICTURE</h4>
          </div>
            <div class="modal-body">
                <p>We only support JPG/JPEG images at the moment.</p>
                <input type="file" id="coinfile">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="upImg()">Upload</button>
            </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
    verify();
    loadFooter();

    // calculations for the ajax total
    $(".values").keyup(updateTotal);
    $(document).ready(updateTotal);

    function updateTotal() {
        var total = Number($('#metal_percentage').text());
        total *= Number($('#quantity').val());
        total *= Number($('#unit_price').val());
        total += Number($("#premium").val())
        $("#total_value").text(total.toFixed(4));
        $("#total_metal_ozt").text(Number($('#quantity').val()) * Number($('#ozt_per_unit').text()))
    }

    // for checking if valid input before submitting
    function validateAdd() {
        // not sure, but parse might validate for us already - Angie
    }

    function onMetalChange() {
        updateTotal();
        var metalDropdown = document.getElementById("metal");

        if(metalDropdown.value == "Gold") {
            $('#metal_percentage_label').html('Gold %');
            $('#grams_per_unit_label').html('Gold g/u');
            $('#ozt_per_unit_label').html('Gold ozt/u');
            $('#total_metal_ozt_label').html('Total au (ozt)');
            $('#metal_percentage').text('0.9167');
            $('#weight_per_unit').text('33.930');
            $('#grams_per_unit').text('33.930');
            $('#ozt_per_unit').text('1.0909');
        } else if(metalDropdown.value == "Silver") {
            $('#metal_percentage_label').html('Silver %');
            $('#grams_per_unit_label').html('Silver g/u');
            $('#ozt_per_unit_label').html('Silver ozt/u');
            $('#total_metal_ozt_label').html('Total ag (ozt)');
            $('#metal_percentage').text('0.999');
            $('#weight_per_unit').text('31.103');
            $('#grams_per_unit').text('31.103');
            $('#ozt_per_unit').text('1.000');
        } else {
            $('#metal_percentage_label').html('Platinum %');
            $('#grams_per_unit_label').html('Platinum g/u');
            $('#ozt_per_unit_label').html('Platinum ozt/u');
            $('#total_metal_ozt_label').html('Total pt (ozt)');
            $('#metal_percentage').text('0.9995');
            $('#weight_per_unit').text('31.120');
            $('#grams_per_unit').text('31.120');
            $('#ozt_per_unit').text('1.0005');
        }
    }

    function upImg() {
        var uploadImage = $("#coinfile")[0];
        var file = uploadImage.files[0];
        var name = $('#coinfile').val().replace(/C:\\fakepath\\/i, '');
         // This function is called when the user clicks on Upload to Parse. It will create the REST API request to upload this image to Parse.
      var serverUrl = 'https://api.parse.com/1/files/' + name;

      $.ajax({
        type: "POST",
        beforeSend: function(request) {
          request.setRequestHeader("X-Parse-Application-Id", 'm8lsJLtBtcOGqT0h9RmcWRIpxpiwyb3Yq6HqrCk2');
          request.setRequestHeader("X-Parse-REST-API-Key", 'JrtCwMABQRvOOtixhzLAZwk46nhxnUlJBIuxx1NZ');
          request.setRequestHeader("Content-Type", file.type);
        },
        url: serverUrl,
        data: file,
        processData: false,
        contentType: false,
        success: function(data) {
            console.log("File available at: " + data.url);
            $(".img_container")[0].innerHTML ='<img id="coinimg" src="'+data.url+'">';
            $('#uploadimg').modal('hide');
          
        },
        error: function(data) {
          var obj = jQuery.parseJSON(data);
          alert(obj.error);
        }
      });

    }

    // saving the coin and inventory
    function saveCoin() {
        if(checkInput() == false)
            return;

        var type = $("#type").val();
        var imgUrl = $('#coinimg').attr('src');
        var gramsPerUnit = parseFloat($("#grams_per_unit").text());
        var metal = $("#metal").val();
        var metalPercentage = parseFloat($("#metal_percentage").text());
        var oztPerUnit = parseFloat($("#ozt_per_unit").text());
        var premium = parseFloat($("#premium").val());
        var unitPrice = parseFloat($("#unit_price").val());
        var weightPerUnit = parseFloat($("#weight_per_unit").text());


        var Coin = Parse.Object.extend("Coin");
        var coin = new Coin();

        coin.save({
            Type: type,
            imageURL: imgUrl,
            gramsPerUnit: gramsPerUnit,
            metal: metal,
            metalPercentage: metalPercentage,
            oztPerUnit: oztPerUnit,
            premium: premium,
            unitPrice: unitPrice,
            weightPerUnit: weightPerUnit
        }, {
            success: function(coin) {
                saveInventory(coin);
            },
            error: function(coin, error) {
                alert("Unable to save coin!");
            }
        });
    }

    function saveInventory(coin) {
        var purchaseDate = new Date($("#purchase_date").val());
        var quantity = parseInt($("#quantity").val());
        var type = coin;
        var totalValue = parseFloat($("#total_value").text());
        var Inventory = Parse.Object.extend("Inventory");
        var inventory = new Inventory();
        inventory.save({
            purchaseDate: purchaseDate,
            quantity: quantity,
            type: type,
            ownedBy: Parse.User.current(),
            value: totalValue
        }, {
            success: function(inventory) {
                window.location.href = "./wire3.html?q=" + $("#metal").val();
            },
            error: function(inventory, error) {
                alert("Unable to save inventory!");
            }
        });
    }

    function checkInput() {
        var error = "";
        var date = $("#purchase_date").val();
        var quantity = $("#quantity").val();
        var premium = $("#premium").val();
        var unitPrice = $("#unit_price").val();

        // regular expression to match required date format
        re = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;

        if(date != '') {
            if(regs = date.match(re)) {
                // month value between 1 and 12
                if(regs[1] < 1 || regs[1] > 12) {
                    error += "Invalid input on 'Purchase Date': Month must be a number from 1 ~ 12\n";
                }
                // day value between 1 and 31
                if(regs[2] < 1 || regs[2] > 31) {
                    error += "Invalid input on 'Purchase Date': Day must be a number from 1 ~ 31\n";
                }
                // year value between 1902 and 2015
                if(regs[3] < 1902 || regs[3] > (new Date()).getFullYear()) {
                    error += "Invalid input on 'Purchase Date': Year must be between 1902 and " + (new Date()).getFullYear() + "\n";
                }
                if((new Date(date)) > (new Date())) {
                    error += "Invalid input on 'Purchase Date': Must be a past date\n";
                }
            } else {
                error += "Invalid input on 'Purchase Date': Format must be mm/dd/yyyy\n";
            }
        }

        if($.isNumeric(quantity) == false) {
            error += "Invalid input on 'Quantity': Must be numeric\n";
        } else {
            if(quantity <= 0)
                error += "Invalid input on 'Quantity': Must be greater than 0\n";
        }

        if($.isNumeric(premium) == false) {
            error += "Invalid input on 'Premium': Must be numeric\n";
        } else {
            if(premium <= 0)
                error += "Invalid input on 'Premium': Must be greater than 0\n";
        }

        if($.isNumeric(unitPrice) == false) {
            error += "Invalid input on 'Unit Price': Must be numeric\n";
        } else {
            if(unitPrice <= 0)
                error += "Invalid input on 'Unit Price': Must be greater than 0\n";
        }

        if(error !== "") {
            alert("Input Error:\n\n" + error);
            return false;
        }

        return true;
    }

    $("#save").click(function() {
        saveCoin();
    });

    $("#cancel").click(function() {
        window.history.back(-1);
    });
    </script>
</body>

</html>
